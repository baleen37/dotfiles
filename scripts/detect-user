#!/usr/bin/env bash
set -euo pipefail

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Try multiple methods to detect user
detect_user() {
    local detected_user=""
    
    # Method 1: USER environment variable
    if [[ -n "${USER:-}" ]]; then
        detected_user="$USER"
        echo "Detected from USER env: $detected_user"
        return 0
    fi
    
    # Method 2: LOGNAME environment variable
    if [[ -n "${LOGNAME:-}" ]]; then
        detected_user="$LOGNAME"
        echo "Detected from LOGNAME env: $detected_user"
        return 0
    fi
    
    # Method 3: whoami command
    if command -v whoami &> /dev/null; then
        detected_user=$(whoami)
        echo "Detected from whoami: $detected_user"
        return 0
    fi
    
    # Method 4: id command
    if command -v id &> /dev/null; then
        detected_user=$(id -un)
        echo "Detected from id: $detected_user"
        return 0
    fi
    
    # Method 5: Check home directory
    if [[ -n "${HOME:-}" ]]; then
        detected_user=$(basename "$HOME")
        echo "Detected from HOME: $detected_user"
        return 0
    fi
    
    # Failed to detect
    return 1
}

# Main detection
echo "Detecting current user..."
if user=$(detect_user); then
    print_success "User detected: $user"
    
    # Export for current session
    export USER="$user"
    
    # Provide instructions for persistence
    echo ""
    echo "To make this permanent, add to your shell profile:"
    echo ""
    
    if [[ -f "$HOME/.zshrc" ]]; then
        echo "  echo 'export USER=\"$user\"' >> ~/.zshrc"
    elif [[ -f "$HOME/.bashrc" ]]; then
        echo "  echo 'export USER=\"$user\"' >> ~/.bashrc"
    else
        echo "  export USER=\"$user\""
    fi
    
    echo ""
    echo "Or run commands with:"
    echo "  USER=$user nix run --impure .#build-switch"
else
    print_error "Failed to detect user automatically"
    print_warning "Please set USER environment variable manually:"
    echo "  export USER=\$(whoami)"
    exit 1
fi