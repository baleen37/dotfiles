#!/usr/bin/env bash

# í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸: auto-branch-update ì›Œí¬í”Œë¡œìš° ë™ì‘ í™•ì¸

set -e

echo "ğŸ§ª Auto Branch Update í…ŒìŠ¤íŠ¸ ì‹œì‘..."

# í˜„ì¬ ë¸Œëœì¹˜ ì €ì¥
ORIGINAL_BRANCH=$(git branch --show-current)

# í…ŒìŠ¤íŠ¸ìš© ë¸Œëœì¹˜ ìƒì„±
TEST_BRANCH="test-auto-update-$(date +%s)"
echo "ğŸ“Œ í…ŒìŠ¤íŠ¸ ë¸Œëœì¹˜ ìƒì„±: $TEST_BRANCH"

# 1. í…ŒìŠ¤íŠ¸ ë¸Œëœì¹˜ ìƒì„± ë° íŒŒì¼ ì¶”ê°€
git checkout -b "$TEST_BRANCH"
echo "test content" > test-file.txt
git add test-file.txt
git commit -m "test: add test file"
git push -u origin "$TEST_BRANCH"

# 2. PR ìƒì„±
echo "ğŸ“ PR ìƒì„± ì¤‘..."
PR_NUMBER=$(gh pr create --title "Test Auto Update" --body "Testing auto branch update" --base main --head "$TEST_BRANCH" | grep -o '[0-9]*$')
echo "âœ… PR #$PR_NUMBER ìƒì„± ì™„ë£Œ"

# 3. main ë¸Œëœì¹˜ì— ìƒˆ ì»¤ë°‹ ì¶”ê°€
git checkout main
echo "main update" > main-update.txt
git add main-update.txt
git commit -m "test: update main branch"
git push origin main

echo "â³ GitHub Actionsê°€ ì‹¤í–‰ë˜ë„ë¡ 30ì´ˆ ëŒ€ê¸°..."
sleep 30

# 4. PR ë¸Œëœì¹˜ í™•ì¸
git fetch origin "$TEST_BRANCH"
git checkout "$TEST_BRANCH"

if git log --oneline | grep -q "update main branch"; then
    echo "âœ… PR ë¸Œëœì¹˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë¨!"
else
    echo "âŒ PR ë¸Œëœì¹˜ê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ"
fi

# 5. ì •ë¦¬
echo "ğŸ§¹ í…ŒìŠ¤íŠ¸ ì •ë¦¬ ì¤‘..."
git checkout "$ORIGINAL_BRANCH"
gh pr close "$PR_NUMBER" --delete-branch
git branch -D "$TEST_BRANCH" 2>/dev/null || true
git push origin --delete "$TEST_BRANCH" 2>/dev/null || true

# main ë¸Œëœì¹˜ ì›ìƒë³µêµ¬
git checkout main
git reset --hard HEAD~1
git push --force-with-lease origin main

echo "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"