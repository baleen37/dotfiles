#!/bin/sh -e

GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
BLUE='\033[1;34m'
NC='\033[0m'

SYSTEM_TYPE="aarch64-darwin"
FLAKE_SYSTEM="darwinConfigurations.${SYSTEM_TYPE}.system"

export NIXPKGS_ALLOW_UNFREE=1

# Set USER if not already set
if [ -z "$USER" ]; then
    export USER=$(whoami)
fi

# Check for verbose flag
VERBOSE=false
for arg in "$@"; do
    if [ "$arg" = "--verbose" ]; then
        VERBOSE=true
        break
    fi
done

print_step() {
    echo "${BLUE}$1${NC}"
}

print_success() {
    echo "${GREEN}âœ… $1${NC}"
}

print_error() {
    echo "${RED}âŒ $1${NC}"
}

# Progress indicator
show_progress() {
    local step=$1
    local total=$2
    local desc=$3
    echo "${YELLOW}ðŸ—ï¸  Dotfiles Build & Switch [$step/$total] - $desc${NC}"
}

# Build phase
show_progress "1" "4" "Building system configuration"
if [ "$VERBOSE" = "true" ]; then
    nix --extra-experimental-features 'nix-command flakes' build --impure .#$FLAKE_SYSTEM $@
else
    nix --extra-experimental-features 'nix-command flakes' build --impure .#$FLAKE_SYSTEM $@ 2>/dev/null || {
        print_error "Build failed. Run with --verbose for details"
        exit 1
    }
fi
print_success "System configuration built"

# Switch phase
show_progress "2" "4" "Switching to new generation"
print_step "â””â”€ Requesting admin privileges..."
if [ "$VERBOSE" = "true" ]; then
    echo "${BLUE}Running: sudo -E USER=\"$USER\" ./result/sw/bin/darwin-rebuild switch --impure --flake .#${SYSTEM_TYPE}${NC}"
    # darwin-rebuild must be run as root, check if we're already root
    if [ "$(id -u)" -eq 0 ]; then
        USER="$USER" ./result/sw/bin/darwin-rebuild switch --impure --flake .#${SYSTEM_TYPE} $@ 2>&1 || {
            print_error "Switch failed with exit code: $?"
            exit 1
        }
    else
        sudo -E USER="$USER" ./result/sw/bin/darwin-rebuild switch --impure --flake .#${SYSTEM_TYPE} $@ 2>&1 || {
            print_error "Switch failed with exit code: $?"
            exit 1
        }
    fi
else
    # darwin-rebuild must be run as root, check if we're already root
    if [ "$(id -u)" -eq 0 ]; then
        USER="$USER" ./result/sw/bin/darwin-rebuild switch --impure --flake .#${SYSTEM_TYPE} $@ 2>/dev/null || {
            print_error "Switch failed. Run with --verbose for details"
            exit 1
        }
    else
        sudo -E USER="$USER" ./result/sw/bin/darwin-rebuild switch --impure --flake .#${SYSTEM_TYPE} $@ 2>/dev/null || {
            print_error "Switch failed. Run with --verbose for details"
            exit 1
        }
    fi
fi
print_success "New generation activated"

# Cleanup phase
show_progress "3" "4" "Cleaning up"
unlink ./result
print_success "Cleanup complete"

# Final
show_progress "4" "4" "Complete"
print_success "System update complete!"
echo "${BLUE}ðŸ’¡ Use --verbose for detailed output${NC}"
