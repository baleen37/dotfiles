#!/bin/bash -e
# Updated build script for aarch64-darwin using optimized structure

# Get script directory
SCRIPT_DIR="$(dirname "$0")"

# Try to use new optimized build system (currently disabled)
if false; then
  echo "Using optimized build system..."
  # Set up proper environment for build scripts
  ROOT_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
  BUILD_SCRIPT_DIR="$ROOT_DIR/scripts/build"

  # Source scripts with absolute paths
  . "$BUILD_SCRIPT_DIR/common.sh"
  . "$BUILD_SCRIPT_DIR/darwin.sh"

  build_darwin "$@"
else
  # Fallback to legacy implementation
  echo "Falling back to legacy build system..."

  GREEN='\033[1;32m'
  YELLOW='\033[1;33m'
  NC='\033[0m'

  SYSTEM_TYPE="aarch64-darwin"
  FLAKE_SYSTEM="darwinConfigurations.${SYSTEM_TYPE}.system"

  export NIXPKGS_ALLOW_UNFREE=1

  # Set USER if not already set
  if [ -z "$USER" ]; then
    USER=$(whoami)
    export USER
  fi

  printf "%bStarting build...%b\n" "$YELLOW" "$NC"
  nix --extra-experimental-features 'nix-command flakes' build --impure ".#$FLAKE_SYSTEM" "$@"

  printf "%bBuild completed successfully!%b\n" "$GREEN" "$NC"
  printf "%bTo apply changes, run: nix run --impure .#build-switch%b\n" "$YELLOW" "$NC"
  printf "%bOr use the result link: ./result/sw/bin/darwin-rebuild switch --impure --flake .#aarch64-darwin%b\n" "$YELLOW" "$NC"
fi
