# 일반적 문제 해결 가이드

## 빌드 및 스위치 오류

### 1. build-switch 실패
**증상**: `nix run #build-switch` 실행 시 권한 오류 또는 실패

**원인 분석**:
```bash
# 스크립트 분석
cat scripts/build-switch.sh

# 권한 요구사항 확인
grep -n "sudo" scripts/build-switch.sh

# 플랫폼별 조건 확인
grep -n "darwin\|linux" scripts/build-switch.sh
```

**해결 방법**:
1. **권한 문제**: sudo 필요 시 사용자 수동 실행 가이드 제공
2. **설정 오류**: `nix flake check --show-trace`로 설정 검증
3. **의존성 문제**: `nix flake update`로 의존성 업데이트

### 2. Nix 빌드 실패
**증상**: `nix build` 명령 실행 시 오류 발생

**진단 프로세스**:
```bash
# 1. 상세 에러 확인
nix build .#target --show-trace --verbose

# 2. 설정 검증
nix flake check --show-trace

# 3. 의존성 상태 확인
nix flake metadata
```

**일반적 해결 방법**:
- **문법 오류**: 설정 파일 문법 검토
- **의존성 오류**: `nix flake lock --update-input nixpkgs`
- **캐시 문제**: `nix store gc && nix store optimise`

## 시스템 설정 문제

### 1. 시스템 서비스 오류
**증상**: 서비스가 시작되지 않거나 비정상 종료

**진단 단계**:
```bash
# 서비스 상태 확인
systemctl status service-name  # Linux
launchctl list | grep service-name  # macOS

# 로그 확인
journalctl -u service-name -f  # Linux
log show --predicate 'process == "service-name"' --last 1h  # macOS
```

**해결 접근법**:
1. **설정 파일 검토**: 서비스 설정 파일 문법 확인
2. **의존성 확인**: 필요한 의존성 서비스 실행 상태 확인
3. **권한 확인**: 서비스 실행 권한 및 파일 접근 권한 확인

### 2. 파일 권한 문제
**증상**: 파일 접근 거부 또는 권한 관련 오류

**진단 방법**:
```bash
# 파일 권한 확인
ls -la /path/to/file

# 소유자 확인
stat /path/to/file

# 프로세스 권한 확인
ps aux | grep process-name
```

**해결 방법**:
- **파일 권한 수정**: `chmod` 명령 사용 (적절한 권한 설정)
- **소유자 변경**: `chown` 명령 사용 (필요한 경우만)
- **그룹 권한**: `chgrp` 명령 사용

## 네트워크 및 연결 문제

### 1. 서비스 외부 접근 불가
**증상**: 로컬에서는 동작하지만 외부에서 접근 불가

**진단 체크리스트**:
```bash
# 1. 서비스 내부 상태 확인
curl -I http://localhost:port/

# 2. 포트 바인딩 확인
netstat -tlnp | grep port  # Linux
lsof -i :port  # macOS

# 3. 방화벽 상태 확인
sudo ufw status  # Linux
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate  # macOS
```

**해결 단계**:
1. **서비스 바인딩**: 0.0.0.0:port로 바인딩 확인
2. **방화벽 설정**: 필요한 포트 개방
3. **네트워크 설정**: 라우팅 테이블 확인

### 2. DNS 및 SSL 문제
**증상**: 도메인 접근 불가 또는 SSL 인증서 오류

**진단 방법**:
```bash
# DNS 확인
nslookup domain.com
dig domain.com

# SSL 인증서 확인
openssl s_client -connect domain.com:443 -servername domain.com

# 연결 테스트
curl -vI https://domain.com/
```

**해결 방법**:
- **DNS 설정**: /etc/hosts 파일 또는 DNS 서버 설정
- **SSL 인증서**: 갱신 또는 재발급
- **프록시 설정**: 프록시 서버 설정 확인

## 패키지 및 의존성 문제

### 1. 패키지 설치 실패
**증상**: 패키지 설치 또는 업데이트 실패

**진단 과정**:
```bash
# 패키지 검색
nix search nixpkgs package-name

# 의존성 확인
nix show-derivation .#package-name

# 빌드 로그 확인
nix build .#package-name --show-trace
```

**해결 방법**:
- **패키지 존재 확인**: 올바른 패키지명 사용
- **의존성 업데이트**: `nix flake update`
- **대안 패키지**: 비슷한 기능의 다른 패키지 사용

### 2. 버전 충돌 문제
**증상**: 패키지 버전 간 충돌 또는 비호환성

**분석 방법**:
```bash
# 현재 패키지 버전 확인
nix-env -q

# 의존성 트리 확인
nix why-depends .#target dependency

# 충돌 패키지 식별
nix show-derivation .#target | grep -i conflict
```

**해결 전략**:
- **버전 고정**: 특정 버전으로 고정
- **패키지 분리**: 충돌하는 패키지들을 별도 환경에 설치
- **오버라이드**: 패키지 의존성 오버라이드

## 설정 파일 문제

### 1. 설정 파일 문법 오류
**증상**: 설정 파일 파싱 오류 또는 문법 오류

**검증 방법**:
```bash
# Nix 설정 검증
nix flake check --show-trace

# JSON 파일 검증
jq . config.json

# YAML 파일 검증
yamllint config.yaml

# Shell 스크립트 검증
shellcheck script.sh
```

**해결 접근법**:
- **문법 검사기 사용**: 언어별 문법 검사 도구 활용
- **단계별 검증**: 변경 사항을 작은 단위로 나누어 검증
- **백업 복구**: 문제 발생 시 이전 버전으로 복구

### 2. 설정 적용 안됨
**증상**: 설정 변경 후에도 이전 설정이 적용됨

**확인 사항**:
```bash
# 설정 파일 위치 확인
find /etc -name "config-name*" 2>/dev/null

# 프로세스 설정 확인
ps aux | grep process-name

# 설정 재로드
sudo systemctl reload service-name  # Linux
sudo launchctl unload && sudo launchctl load service.plist  # macOS
```

**해결 방법**:
- **서비스 재시작**: 설정 변경 후 서비스 재시작
- **캐시 초기화**: 설정 캐시 파일 삭제
- **우선순위 확인**: 다른 설정 파일의 우선순위 확인

## 성능 문제

### 1. 빌드 시간 과도함
**증상**: Nix 빌드 시간이 매우 오래 걸림

**분석 방법**:
```bash
# 빌드 성능 분석
nix build .#target --verbose

# 의존성 크기 확인
nix path-info -S .#target

# 빌드 병목 지점 확인
nix show-derivation .#target
```

**최적화 방법**:
- **바이너리 캐시**: 신뢰할 수 있는 바이너리 캐시 사용
- **병렬 빌드**: 빌드 코어 수 조정
- **불필요한 의존성**: 사용하지 않는 패키지 제거

### 2. 메모리 사용량 과다
**증상**: 시스템 메모리 부족 또는 과도한 사용

**진단 도구**:
```bash
# 메모리 사용량 확인
htop
free -h  # Linux
vm_stat  # macOS

# 프로세스별 메모리 사용량
ps aux --sort=-%mem | head -10
```

**해결 방법**:
- **메모리 누수**: 문제 프로세스 재시작
- **스왑 설정**: 적절한 스왑 공간 확보
- **리소스 제한**: 프로세스별 메모리 제한 설정

## 트러블슈팅 체크리스트

### 문제 발생 시 초기 대응
- [ ] 에러 메시지 전체 복사 및 분석
- [ ] 최근 변경 사항 확인 (git log)
- [ ] 시스템 로그 확인
- [ ] 유사한 문제 사례 검색

### 진단 과정
- [ ] 문제 재현 가능성 확인
- [ ] 최소 재현 환경 구성
- [ ] 의존성 및 환경 변수 확인
- [ ] 권한 및 네트워크 설정 확인

### 해결 방법 적용
- [ ] 백업 생성 (변경 전)
- [ ] 단계별 적용 및 검증
- [ ] 부작용 확인
- [ ] 문서화 (해결 과정 기록)

---

*문제 해결 시 근본 원인을 파악하고 임시방편보다는 근본적 해결책을 우선하세요.*
