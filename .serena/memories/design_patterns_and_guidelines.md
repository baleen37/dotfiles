# 설계 패턴 및 가이드라인

## 아키텍처 원칙

### 모듈화
- **단일 책임**: 각 모듈은 하나의 기능에 집중
- **플랫폼 분리**: 공유/darwin/nixos로 명확한 분리
- **재사용성**: 공통 기능은 `lib/`에서 유틸리티로 제공

### 설정 관리 패턴
- **외부화**: 설정은 `config/` YAML 파일로 분리
- **오버라이드**: 환경 변수로 설정 오버라이드 지원
- **검증**: 설정 파일 유효성 검사 스크립트 제공

## Nix 패턴

### Flake 구조
- **입력 관리**: 모든 외부 의존성을 flake inputs로 명시
- **출력 정의**: 시스템별 출력을 명확히 정의
- **모듈 임포트**: 기능별 모듈 분리로 가독성 향상

### 시스템 설정 패턴
- **Home Manager**: 사용자 환경 설정
- **nix-darwin**: macOS 시스템 설정
- **NixOS**: Linux 시스템 설정
- **공유 설정**: 플랫폼 무관한 설정은 shared 모듈에

## 테스트 패턴

### 다계층 테스트
- **Unit**: 개별 컴포넌트 검증
- **Integration**: 모듈 간 상호작용 검증
- **E2E**: 전체 워크플로 검증
- **Performance**: 빌드 시간 및 리소스 모니터링

### 테스트 전략
- **빠른 피드백**: smoke 테스트로 빠른 검증
- **CI 일치**: 로컬과 CI 환경 일치
- **자동화**: pre-commit hook으로 자동 품질 검사

## Claude Code 통합 패턴

### 설정 보존
- **변경 감지**: SHA256 기반 수정 추적
- **안전 업데이트**: `.new` 파일로 신버전 보존
- **상호작용 해결**: 수동 병합 도구 제공
- **자동 백업**: 30일 보존 정책의 타임스탬프 백업

### 명령어 시스템
- **모듈화**: 명령어별 개별 파일
- **네임스페이스**: git 관련 명령어는 `commands/git/`에
- **활성화**: `claude-activation.nix`로 자동 설정

## 성능 최적화 패턴

### 빌드 최적화
- **병렬 빌드**: 플랫폼별 병렬 처리
- **타겟팅**: 현재 플랫폼만 빌드하는 옵션
- **캐싱**: 빌드 아티팩트 캐싱 및 재사용
- **모니터링**: 빌드 시간 및 메모리 사용량 추적