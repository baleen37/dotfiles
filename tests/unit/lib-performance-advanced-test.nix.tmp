# ============================================================================
# DISABLED TEST - lib-performance-advanced-test.nix
# ============================================================================
#
# WHAT THIS TESTS:
#   Advanced unit tests for lib/performance.nix functions. Tests cover:
#   - perf.time.measure: Returns value, duration, timing metrics, success status
#   - perf.time.benchmark: Iteration execution with statistics (min/max/avg)
#   - perf.memory.monitor: Memory tracking with before/after/delta metrics
#   - perf.build.measureEval: Evaluation performance measurement
#   - perf.build.measureDerivation: Derivation build performance
#   - perf.build.measureConfigComplexity: Configuration complexity analysis
#   - perf.resources.profile: Comprehensive resource profiling with CPU/memory
#   - perf.resources.compare: Comparative analysis between operations
#   - perf.testing.mkPerfTest: Performance test creation and execution
#   - perf.testing.mkBenchmarkSuite: Benchmark suite management
#   - perf.report.formatResults: Report generation and formatting
#
# WHY DISABLED:
#   The performance testing framework appears to be a sophisticated performance
#   measurement system that may not be stable or fully integrated. Possible reasons:
#   1. Performance tests may be flaky due to environmental variations
#   2. The framework may still be under active development
#   3. Performance tests may be intended for manual/periodic running only
#   4. Time measurements may not be reliable in all CI environments
#
# WHAT WOULD NEED TO BE FIXED TO RE-ENABLE:
#   1. Stabilize performance measurements across different environments
#   2. Add tolerance/thresholds for environmental variations
#   3. Ensure tests are deterministic and not affected by system load
#   4. Consider running performance tests only in specific CI jobs
#   5. Verify all functions are working as expected with current Nix version
#   6. Rename file from .nix.disabled to .nix to re-enable
#
# WHEN DISABLED:
#   Date unknown (file was already disabled when this documentation was added)
#   Documentation added: 2026-01-08
#
# TOTAL TESTS: 23 tests covering advanced performance measurement functionality
# ============================================================================

# tests/unit/lib-performance-advanced-test.nix
# Advanced unit tests for lib/performance.nix functions
# Tests detailed functionality beyond basic existence checks

{
  inputs,
  system,
  pkgs,
  lib,
  self,
  nixtest,
}:

let
  testHelpers = import ../lib/test-helpers.nix { inherit lib pkgs; };
  perf = import ../../lib/performance.nix { inherit lib pkgs; };

in
{
  # Test 1: perf.time.measure returns expected structure
  time-measure-structure = testHelpers.assertTest "perf-time-measure-structure" (
    let
      result = perf.perf.time.measure (builtins.deepSeq 42 42);
    in
    builtins.hasAttr "value" result
    && builtins.hasAttr "duration" result
    && builtins.hasAttr "start" result
    && builtins.hasAttr "end" result
    && builtins.hasAttr "success" result
    && builtins.hasAttr "duration_ms" result
    && builtins.hasAttr "duration_s" result
  ) "perf.time.measure should return result with all expected attributes";

  # Test 2: perf.time.measure returns successful result
  time-measure-success = testHelpers.assertTest "perf-time-measure-success" (
    let
      result = perf.perf.time.measure (builtins.deepSeq 42 42);
    in
    result.success == true
  ) "perf.time.measure should return successful result for valid computation";

  # Test 3: perf.time.measure captures correct value
  time-measure-value = testHelpers.assertTest "perf-time-measure-value" (
    let
      result = perf.perf.time.measure (builtins.deepSeq 123 123);
    in
    result.value == 123
  ) "perf.time.measure should capture the computed value";

  # Test 4: perf.time.benchmark returns expected structure
  time-benchmark-structure = testHelpers.assertTest "perf-time-benchmark-structure" (
    let
      result = perf.perf.time.benchmark (builtins.deepSeq 1 1) 5;
    in
    builtins.hasAttr "iterations" result
    && builtins.hasAttr "totalDuration" result
    && builtins.hasAttr "averageDuration" result
    && builtins.hasAttr "minDuration" result
    && builtins.hasAttr "maxDuration" result
    && builtins.hasAttr "successRate" result
    && builtins.hasAttr "averageDuration_ms" result
    && builtins.hasAttr "averageDuration_s" result
  ) "perf.time.benchmark should return result with all expected attributes";

  # Test 5: perf.time.benchmark runs correct iterations
  time-benchmark-iterations = testHelpers.assertTest "perf-time-benchmark-iterations" (
    let
      result = perf.perf.time.benchmark (builtins.deepSeq 1 1) 10;
    in
    result.iterations == 10
  ) "perf.time.benchmark should run the specified number of iterations";

  # Test 6: perf.memory.monitor returns memory metrics
  memory-monitor-structure = testHelpers.assertTest "perf-memory-monitor-structure" (
    let
      result = perf.perf.memory.monitor (builtins.deepSeq "test" "test");
    in
    builtins.hasAttr "memoryBefore" result
    && builtins.hasAttr "memoryAfter" result
    && builtins.hasAttr "memoryDelta" result
    && builtins.hasAttr "duration" result
    && builtins.hasAttr "duration_ms" result
  ) "perf.memory.monitor should return result with memory metrics";

  # Test 7: perf.memory.monitor captures memory delta
  memory-monitor-delta = testHelpers.assertTest "perf-memory-monitor-delta" (
    let
      result = perf.perf.memory.monitor (builtins.deepSeq "x" "x");
    in
    result ? memoryDelta
  ) "perf.memory.monitor should capture memory delta";

  # Test 8: perf.build.measureEval returns evaluation metrics
  build-measure-eval-structure = testHelpers.assertTest "perf-build-measure-eval-structure" (
    let
      result = perf.build.measureEval { x = 1; y = 2; };
    in
    builtins.hasAttr "value" result
    && builtins.hasAttr "duration" result
    && builtins.hasAttr "duration_ms" result
  ) "perf.build.measureEval should return evaluation metrics";

  # Test 9: perf.build.measureDerivation returns metrics
  build-measure-derivation-structure = testHelpers.assertTest "perf-build-measure-derivation-structure" (
    let
      drv = pkgs.hello;
      result = perf.build.measureDerivation drv;
    in
    builtins.hasAttr "value" result
    && builtins.hasAttr "duration" result
    && builtins.hasAttr "success" result
  ) "perf.build.measureDerivation should return derivation metrics";

  # Test 10: perf.build.measureConfigComplexity returns complexity metrics
  build-measure-complexity-structure = testHelpers.assertTest "perf-build-measure-complexity-structure" (
    let
      config = { foo = "bar"; baz = [1 2 3]; };
      result = perf.build.measureConfigComplexity config;
    in
    builtins.hasAttr "attributeCount" result
    && builtins.hasAttr "estimatedSize" result
    && builtins.hasAttr "complexity" result
    && builtins.hasAttr "duration" result
    && builtins.hasAttr "duration_ms" result
  ) "perf.build.measureConfigComplexity should return complexity metrics";

  # Test 11: perf.build.measureConfigComplexity counts attributes
  build-measure-complexity-counts = testHelpers.assertTest "perf-build-measure-complexity-counts" (
    let
      config = { a = 1; b = 2; c = 3; };
      result = perf.build.measureConfigComplexity config;
    in
    result.attributeCount == 3
  ) "perf.build.measureConfigComplexity should count attributes correctly";

  # Test 12: perf.build.measureConfigComplexity complexity structure
  build-measure-complexity-complexity = testHelpers.assertTest "perf-build-measure-complexity-complexity" (
    let
      config = { x = 1; };
      result = perf.build.measureConfigComplexity config;
    in
    builtins.hasAttr "attributes" result.complexity
    && builtins.hasAttr "size_bytes" result.complexity
    && builtins.hasAttr "size_kb" result.complexity
    && builtins.hasAttr "size_mb" result.complexity
  ) "perf.build.measureConfigComplexity should return complexity with attributes and sizes";

  # Test 13: perf.resources.profile returns profile
  resources-profile-structure = testHelpers.assertTest "perf-resources-profile-structure" (
    let
      result = perf.resources.profile (builtins.deepSeq 42 42);
    in
    builtins.hasAttr "memoryBefore" result
    && builtins.hasAttr "memoryAfter" result
    && builtins.hasAttr "memoryDelta" result
    && builtins.hasAttr "duration" result
    && builtins.hasAttr "duration_ms" result
    && builtins.hasAttr "cpu" result
    && builtins.hasAttr "profile" result
  ) "perf.resources.profile should return comprehensive resource profile";

  # Test 14: perf.resources.profile includes cpu metrics
  resources-profile-cpu = testHelpers.assertTest "perf-resources-profile-cpu" (
    let
      result = perf.resources.profile (builtins.deepSeq 42 42);
    in
    builtins.hasAttr "estimatedCycles" result.cpu
    && builtins.hasAttr "efficiency" result.cpu
  ) "perf.resources.profile should include CPU metrics";

  # Test 15: perf.resources.profile includes profile metadata
  resources-profile-metadata = testHelpers.assertTest "perf-resources-profile-metadata" (
    let
      result = perf.resources.profile (builtins.deepSeq 42 42);
    in
    builtins.hasAttr "timestamp" result.profile
    && builtins.hasAttr "operation" result.profile
    && builtins.hasAttr "hostSystem" result.profile
  ) "perf.resources.profile should include profile metadata";

  # Test 16: perf.resources.compare returns comparison
  resources-compare-structure = testHelpers.assertTest "perf-resources-compare-structure" (
    let
      result = perf.resources.compare
        (builtins.deepSeq 1 1)
        (builtins.deepSeq 2 2);
    in
    builtins.hasAttr "operation1" result
    && builtins.hasAttr "operation2" result
    && builtins.hasAttr "comparison" result
  ) "perf.resources.compare should return comparison of two operations";

  # Test 17: perf.resources.compare includes ratios
  resources-compare-ratios = testHelpers.assertTest "perf-resources-compare-ratios" (
    let
      result = perf.resources.compare
        (builtins.deepSeq 1 1)
        (builtins.deepSeq 2 2);
    in
    builtins.hasAttr "timeRatio" result.comparison
    && builtins.hasAttr "memoryRatio" result.comparison
    && builtins.hasAttr "efficiency" result.comparison
  ) "perf.resources.compare should include time, memory, and efficiency ratios";

  # Test 18: perf.testing.mkPerfTest creates test
  testing-mk-perf-test-structure = testHelpers.assertTest "perf-testing-mk-perf-test-structure" (
    let
      test = perf.testing.mkPerfTest "test-op" (builtins.deepSeq 1 1) { };
    in
    builtins.hasAttr "name" test
    && builtins.hasAttr "operation" test
    && builtins.hasAttr "expectedThresholds" test
    && builtins.hasAttr "type" test
    && builtins.hasAttr "run" test
    && test.type == "performance-test"
  ) "perf.testing.mkPerfTest should create performance test";

  # Test 19: perf.testing.mkPerfTest run executes
  testing-mk-perf-test-run = testHelpers.assertTest "perf-testing-mk-perf-test-run" (
    let
      test = perf.testing.mkPerfTest "test-op" (builtins.deepSeq 1 1) { };
      result = test.run;
    in
    builtins.hasAttr "passed" result
    && builtins.hasAttr "duration_ms" result
    && builtins.hasAttr "memoryAfter" result
  ) "perf.testing.mkPerfTest run should execute and return result";

  # Test 20: perf.testing.mkBenchmarkSuite creates suite
  testing-mk-benchmark-suite-structure = testHelpers.assertTest "perf-testing-mk-benchmark-suite-structure" (
    let
      tests = [
        (perf.testing.mkPerfTest "test1" (builtins.deepSeq 1 1) { })
        (perf.testing.mkPerfTest "test2" (builtins.deepSeq 2 2) { })
      ];
      suite = perf.testing.mkBenchmarkSuite "my-suite" tests;
    in
    builtins.hasAttr "name" suite
    && builtins.hasAttr "results" suite
    && builtins.hasAttr "type" suite
    && builtins.hasAttr "summary" suite
    && suite.type == "benchmark-suite"
  ) "perf.testing.mkBenchmarkSuite should create benchmark suite";

  # Test 21: perf.testing.mkBenchmarkSuite includes summary
  testing-mk-benchmark-suite-summary = testHelpers.assertTest "perf-testing-mk-benchmark-suite-summary" (
    let
      tests = [
        (perf.testing.mkPerfTest "test1" (builtins.deepSeq 1 1) { })
      ];
      suite = perf.testing.mkBenchmarkSuite "my-suite" tests;
    in
    builtins.hasAttr "totalMeasurements" suite.summary
    && builtins.hasAttr "timing" suite.summary
    && builtins.hasAttr "memory" suite.summary
  ) "perf.testing.mkBenchmarkSuite should include performance summary";

  # Test 22: perf.report.formatResults returns string
  report-format-results-type = testHelpers.assertTest "perf-report-format-results-type" (
    let
      measurements = [
        { duration_ms = 100; memoryAfter = 1000; success = true; }
        { duration_ms = 200; memoryAfter = 2000; success = true; }
      ];
      summary = perf.report.summary measurements;
      formatted = perf.report.formatResults summary;
    in
    builtins.typeOf formatted == "string"
    && builtins.stringLength formatted > 0
  ) "perf.report.formatResults should return formatted string";

  # Test 23: perf.report.formatResults contains expected sections
  report-format-results-content = testHelpers.assertTest "perf-report-format-results-content" (
    let
      measurements = [
        { duration_ms = 100; memoryAfter = 1000; success = true; }
      ];
      summary = perf.report.summary measurements;
      formatted = perf.report.formatResults summary;
    in
    lib.hasInfix "Performance Test Results" formatted
    && lib.hasInfix "Summary" formatted
    && lib.hasInfix "Timing Metrics" formatted
    && lib.hasInfix "Memory Metrics" formatted
  ) "perf.report.formatResults should contain all expected sections";
}
