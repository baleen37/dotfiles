name: 'Setup Nix with Cache'
description: 'Install Nix and setup caching with week-based rotation'
inputs:
  enable-kvm:
    description: 'Enable KVM support (automatically enabled on Linux)'
    required: false
    default: 'true'
  cache-mode:
    description: 'Cache mode: "full" (save and restore) or "restore-only" (restore only)'
    required: false
    default: 'full'
runs:
  using: 'composite'
  steps:
    - name: Install Nix
      uses: DeterminateSystems/nix-installer-action@7ba22a244ba4bf8a2cf5ce5d58b5d1df6e565d16 # v21
      with:
        extra-conf: |
          experimental-features = nix-command flakes
          accept-flake-config = true

    - name: Get week number for cache rotation
      id: date
      shell: bash
      run: echo "week=$(date +%Y-W%U)" >> $GITHUB_OUTPUT

    - name: Restore Nix cache (full mode)
      if: inputs.cache-mode == 'full'
      uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      with:
        path: |
          ~/.cache/nix
          ~/.local/state/nix
        key: nix-${{ runner.os }}-${{ hashFiles('**/flake.lock') }}-${{ steps.date.outputs.week }}
        restore-keys: |
          nix-${{ runner.os }}-${{ hashFiles('**/flake.lock') }}-
          nix-${{ runner.os }}-
      continue-on-error: true

    - name: Restore Nix cache (restore-only mode)
      if: inputs.cache-mode == 'restore-only'
      uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      with:
        path: |
          ~/.cache/nix
          ~/.local/state/nix
        key: nix-${{ runner.os }}-${{ hashFiles('**/flake.lock') }}-${{ steps.date.outputs.week }}
        restore-keys: |
          nix-${{ runner.os }}-${{ hashFiles('**/flake.lock') }}-
          nix-${{ runner.os }}-
      continue-on-error: true

    - name: Cache status check
      shell: bash
      run: |
        echo "üîç Cache configuration:"
        echo "  - Cache mode: ${{ inputs.cache-mode }}"
        echo "  - Cache key: nix-${{ runner.os }}-${{ hashFiles('**/flake.lock') }}-${{ steps.date.outputs.week }}"
        echo "  - Week: ${{ steps.date.outputs.week }}"
        echo "  - Flake.lock hash: ${{ hashFiles('**/flake.lock') }}"

    - name: Save Nix cache (full mode only)
      if: inputs.cache-mode == 'full' && always()
      uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      continue-on-error: true
      with:
        path: |
          ~/.cache/nix
          ~/.local/state/nix
        key: nix-${{ runner.os }}-${{ hashFiles('**/flake.lock') }}-${{ steps.date.outputs.week }}
