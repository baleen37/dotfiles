# ABOUTME: GitHub Actions CI/CD íŒŒì´í”„ë¼ì¸
# ABOUTME: ë‹¤ì¤‘ í”Œë«í¼ì—ì„œ í¬ê´„ì ì¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰

name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # ë¹ ë¥¸ ê²€ì¦ (lint, smoke)
  quick-checks:
    name: "ë¹ ë¥¸ ê²€ì¦ ğŸš€"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ì €ì¥ì†Œ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Nix ì„¤ì¹˜
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          logger: pretty

      - name: Magic Nix Cache ì„¤ì •
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Lint ê²€ì‚¬
        run: nix develop --command make lint

      - name: Smoke í…ŒìŠ¤íŠ¸
        run: make smoke

      - name: í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ ìƒíƒœ í™•ì¸
        run: make test-status

  # í”Œë«í¼ë³„ í…ŒìŠ¤íŠ¸ ë§¤íŠ¸ë¦­ìŠ¤
  test-matrix:
    name: "í…ŒìŠ¤íŠ¸ ${{ matrix.test-type }} on ${{ matrix.os }}"
    needs: quick-checks
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.experimental }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-13      # x86_64
          - macos-14      # aarch64
        test-type:
          - unit
          - integration
          - contract
          - security
          - compatibility
        exclude:
          # Ubuntuì—ì„œëŠ” ì¼ë¶€ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
          - os: ubuntu-latest
            test-type: integration
          - os: ubuntu-latest
            test-type: security
        include:
          # ì‹¤í—˜ì  í…ŒìŠ¤íŠ¸ë“¤
          - os: ubuntu-latest
            test-type: e2e
            experimental: true
          - os: macos-13
            test-type: e2e
            experimental: true
          - os: macos-14
            test-type: e2e
            experimental: true
          - os: macos-14
            test-type: perf
            experimental: true

    steps:
      - name: Checkout ì €ì¥ì†Œ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Nix ì„¤ì¹˜
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          logger: pretty

      - name: Magic Nix Cache ì„¤ì •
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ - ${{ matrix.test-type }}
        run: nix develop --command make test-${{ matrix.test-type }}
        env:
          USER: ${{ github.actor }}

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-type }}-${{ matrix.os }}
          path: |
            /tmp/test-*
            *.log
          retention-days: 7

  # ë¹Œë“œ í…ŒìŠ¤íŠ¸ (ê° í”Œë«í¼ë³„)
  build-test:
    name: "ë¹Œë“œ í…ŒìŠ¤íŠ¸ ${{ matrix.platform }}"
    needs: quick-checks
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "x86_64-linux"
            runner: ubuntu-latest
          - platform: "aarch64-linux"
            runner: ubuntu-latest
          - platform: "x86_64-darwin"
            runner: macos-13
          - platform: "aarch64-darwin"
            runner: macos-14

    steps:
      - name: Checkout ì €ì¥ì†Œ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Nix ì„¤ì¹˜
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          logger: pretty

      - name: Magic Nix Cache ì„¤ì •
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: í”Œë«í¼ë³„ ë¹Œë“œ í…ŒìŠ¤íŠ¸
        run: |
          if [[ "${{ matrix.platform }}" == *"linux"* ]]; then
            make build-linux
          else
            make build-darwin
          fi
        env:
          USER: ${{ github.actor }}

  # ì¢…í•© ë³´ê³ ì„œ
  test-summary:
    name: "í…ŒìŠ¤íŠ¸ ìš”ì•½ ğŸ“Š"
    needs: [test-matrix, build-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout ì €ì¥ì†Œ
        uses: actions/checkout@v4

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          path: test-results

      - name: í…ŒìŠ¤íŠ¸ ìš”ì•½ ìƒì„±
        run: |
          {
            echo "## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½"
            echo ""
            echo "### í”Œë«í¼ë³„ í…ŒìŠ¤íŠ¸ ìƒíƒœ"
            echo ""
            echo "| í”Œë«í¼ | Unit | Integration | Contract | Security | Compatibility |"
            echo "|--------|------|-------------|----------|----------|---------------|"
          } >> "$GITHUB_STEP_SUMMARY"

          for os in ubuntu-latest macos-13 macos-14; do
            echo -n "| $os |" >> "$GITHUB_STEP_SUMMARY"
            for test_type in unit integration contract security compatibility; do
              if ls test-results/test-results-"${test_type}"-"${os}"* >/dev/null 2>&1; then
                echo -n " âœ… |" >> "$GITHUB_STEP_SUMMARY"
              else
                echo -n " âŒ |" >> "$GITHUB_STEP_SUMMARY"
              fi
            done
            echo "" >> "$GITHUB_STEP_SUMMARY"
          done

      - name: ì‹¤íŒ¨í•œ ì‘ì—… í™•ì¸
        if: needs.test-matrix.result == 'failure' || needs.build-test.result == 'failure'
        run: |
          echo "ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." >&2
          exit 1

  # ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ (ì„ íƒì )
  performance-benchmark:
    name: "ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ âš¡"
    needs: quick-checks
    runs-on: macos-14  # ì¼ê´€ëœ ì„±ëŠ¥ ì¸¡ì •ì„ ìœ„í•´ ê³ ì •
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout ì €ì¥ì†Œ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Nix ì„¤ì¹˜
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          logger: pretty

      - name: Magic Nix Cache ì„¤ì •
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: make test-perf
        env:
          USER: ${{ github.actor }}

      - name: ì„±ëŠ¥ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: |
            perf-*.json
            benchmark-*.log
          retention-days: 30
