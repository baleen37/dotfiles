name: CI - Optimized Stable Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-matrix:
    strategy:
      fail-fast: false
      matrix:
        platform:
          - { name: "Darwin (Apple Silicon)", os: "macos-15", arch: "aarch64-darwin" }
          - { name: "Linux x64", os: "ubuntu-latest", arch: "x86_64-linux" }
          - { name: "Linux ARM", os: "ubuntu-latest", arch: "aarch64-linux" }

    runs-on: ${{ matrix.platform.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: cachix/install-nix-action@v22
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Setup Cachix
      uses: cachix/cachix-action@v12
      with:
        name: baleen-nix
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

    - name: Run stable tests
      run: |
        echo "üß™ Running stable tests on ${{ matrix.platform.name }}..."
        time make test

    - name: Verify test execution time
      run: |
        echo "‚è±Ô∏è Measuring test execution time..."
        start_time=$(date +%s)
        make test
        end_time=$(date +%s)
        duration=$((end_time - start_time))
        echo "Total execution time: $duration seconds"

        # Assert tests complete within 60 seconds (CI allowance)
        if [ $duration -gt 60 ]; then
          echo "‚ùå Tests took too long: $duration seconds (max: 60s)"
          exit 1
        else
          echo "‚úÖ Tests completed within time limit"
        fi
