name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  NIX_CONFIG: |
    max-jobs = auto
    cores = 0
    substituters = https://cache.nixos.org https://nix-community.cachix.org https://baleen-nix.cachix.org
    trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= baleen-nix.cachix.org-1:awgC7Sut148An/CZ6TZA+wnUtJmJnOvl5NThGio9j5k=
    fallback = true
    narinfo-cache-negative-ttl = 0

jobs:
  ci:
    name: CI (${{ matrix.name }})
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Darwin
            os: macos-15
            vm-timeout: 45
            cores: 4
          - name: Linux x64
            os: ubuntu-latest
            vm-timeout: 30
            cores: 2
          - name: Linux ARM
            os: ubuntu-latest
            vm-timeout: 45
            cores: 2
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0

      - name: Setup Nix with cache
        uses: ./.github/actions/setup-nix
        with:
          enable-kvm: ${{ runner.os == 'Linux' }}

      - name: Verify KVM availability (Linux only)
        if: runner.os == 'Linux'
        run: |
          echo "üîç Verifying KVM availability for VM testing..."
          if [ -e /dev/kvm ]; then
            echo "‚úÖ KVM device available"
            ls -la /dev/kvm
            echo "DETERMINATE_NIX_KVM=$DETERMINATE_NIX_KVM"
          else
            echo "‚ö†Ô∏è  KVM device not found - VM tests may run slower without hardware acceleration"
          fi

      - name: Lint
        run: |
          export USER=${USER:-ci}
          git config --unset-all core.hooksPath || true
          make lint

      - name: Build
        run: |
          export USER=${USER:-ci}
          make build

      - name: Test
        run: |
          export USER=${USER:-ci}
          # Run unit and integration tests, skip VM tests in CI for stability
          make test-unit test-integration

      - name: E2E Test
        run: |
          export USER=${USER:-ci}
          make test-e2e

      - name: VM Test
        timeout-minutes: ${{ matrix.vm-timeout }}
        run: |
          export USER=${USER:-ci}
          export CI=true
          export GITHUB_ACTIONS=true
          # Enable VM testing in CI by overriding the skip behavior
          export ENABLE_VM_TESTS_IN_CI=true
          # Set VM testing parameters for CI
          export VM_TIMEOUT=${{ matrix.vm-timeout }}
          export VM_CORES=${{ matrix.cores }}
          echo "üöÄ Running VM tests in CI environment..."
          echo "üéØ Platform: ${{ runner.os }} (${{ matrix.name }})"
          echo "‚è±Ô∏è  VM timeout: ${{ matrix.vm-timeout }} minutes"
          echo "üîß VM cores: ${{ matrix.cores }}"

          # Use lightweight fallback for Darwin to avoid cross-compilation timeouts
          if [[ "${{ runner.os }}" == "macOS" ]]; then
            echo "üçé Darwin detected - using lightweight VM validation..."
            make test-vm-fallback
          else
            echo "üêß Linux detected - using full VM test suite..."
            make test-vm
          fi

      - name: Upload to Cachix
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        env:
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
        run: |
          nix profile install nixpkgs#cachix
          nix path-info --json --all | jq -r '.[].storePath' | cachix push baleen-nix
