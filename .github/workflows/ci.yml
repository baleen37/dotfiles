name: CI
on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  NIX_CONFIG: |
    max-jobs = auto
    cores = 0
    substituters = https://cache.nixos.org https://nix-community.cachix.org
    trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=
  # Single environment variable to control entire pipeline
  CI_MODE: ${{ github.event.pull_request.draft == true && 'draft' || 'full' }}
  IS_MAIN: ${{ github.ref == 'refs/heads/main' }}

jobs:
  # Fast validation stage (1-2 minutes)
  validate:
    name: Validate & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show CI mode
        run: |
          echo "🎯 CI Mode: $CI_MODE"
          echo "📍 Is Main: $IS_MAIN"

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Cache Nix store
        uses: actions/cache@v4
        with:
          path: |
            /nix/store
            ~/.cache/nix
          key: validate-nix-${{ hashFiles('flake.lock') }}
          restore-keys: validate-nix-

      - name: Lint
        run: |
          nix-shell -p pre-commit --run "pre-commit install"
          nix-shell -p pre-commit --run "pre-commit run --all-files"

      - name: Validate flake
        run: |
          export USER=${USER:-ci}
          nix flake check --impure --no-build --all-systems

  # Core build stage (2-4 minutes) - Only essential platforms
  build-core:
    name: Build ${{ matrix.name }}
    needs: validate
    if: (github.event.pull_request.draft != true) || (github.ref == 'refs/heads/main')
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Darwin ARM64"
            system: aarch64-darwin
            os: macos-latest
            build_type: full
          - name: "Linux x64"
            system: x86_64-linux
            os: ubuntu-latest
            build_type: full
          - name: "Darwin x64"
            system: x86_64-darwin
            os: macos-13
            build_type: validate
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Cache Nix store
        uses: actions/cache@v4
        with:
          path: |
            /nix/store
            ~/.cache/nix
          key: ${{ runner.os }}-${{ matrix.system }}-${{ hashFiles('flake.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.system }}-
            ${{ runner.os }}-nix-
            validate-nix-

      - name: Build configuration
        timeout-minutes: 30
        run: |
          export USER=${USER:-ci}
          echo "🏗️ Building ${{ matrix.name }} (${{ matrix.system }}) - Type: ${{ matrix.build_type }}"

          case "${{ matrix.system }}" in
            *darwin*)
              if [[ "${{ matrix.build_type }}" == "full" ]]; then
                echo "Running full Darwin build..."
                nix build --impure --no-link .#darwinConfigurations.${{ matrix.system }}.system
              else
                echo "Running Darwin validation..."
                nix eval --impure .#darwinConfigurations.${{ matrix.system }}.system --json >/dev/null
              fi
              ;;
            *linux*)
              echo "Running NixOS validation..."
              nix eval --impure .#nixosConfigurations.${{ matrix.system }}.config.system.name --json >/dev/null
              ;;
          esac
          echo "✅ Build completed successfully"

  # Parallel test stage (2-3 minutes)
  test-parallel:
    name: Test ${{ matrix.category }}
    needs: [validate, build-core]
    if: (github.event.pull_request.draft != true) || (github.ref == 'refs/heads/main')
    strategy:
      fail-fast: false
      matrix:
        category: [unit, integration, perf]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Restore Nix cache
        uses: actions/cache/restore@v4
        with:
          path: |
            /nix/store
            ~/.cache/nix
          key: macOS-aarch64-darwin-${{ hashFiles('flake.lock') }}
          restore-keys: |
            macOS-aarch64-darwin-
            validate-nix-

      - name: Run tests
        timeout-minutes: 15
        run: |
          export USER=${USER:-ci}
          echo "🧪 Running ${{ matrix.category }} tests"
          nix run --impure .#test-${{ matrix.category }}

  # Smoke test for draft PRs (30 seconds)
  smoke-test:
    name: Smoke Test
    needs: validate
    if: github.event.pull_request.draft == true && github.ref != 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Quick smoke test
        run: |
          export USER=${USER:-ci}
          nix flake check --impure --no-build --all-systems
          echo "✅ Smoke test passed - Draft PR validation complete"

  # Summary and status reporting
  ci-complete:
    name: CI Summary
    needs: [validate, build-core, test-parallel, smoke-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Determine overall status
        id: status
        run: |
          validation_result="${{ needs.validate.result }}"
          build_result="${{ needs.build-core.result }}"
          test_result="${{ needs.test-parallel.result }}"
          smoke_result="${{ needs.smoke-test.result }}"

          # Simplified status determination logic
          if [[ "$validation_result" != "success" ]]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "message=Validation failed" >> $GITHUB_OUTPUT
          elif [[ "$CI_MODE" == "draft" ]]; then
            if [[ "$smoke_result" == "success" ]]; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "message=Draft PR validation passed (smoke test only)" >> $GITHUB_OUTPUT
            else
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "message=Draft PR smoke test failed" >> $GITHUB_OUTPUT
            fi
          else
            if [[ "$build_result" == "success" && "$test_result" == "success" ]]; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "message=Full CI pipeline completed successfully" >> $GITHUB_OUTPUT
            else
              echo "status=failed" >> $GITHUB_OUTPUT
              echo "message=Build or test stage failed" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // Helper functions for cleaner code
              function getStatusIcon(result) {
                return result === 'success' ? '✅' : '❌';
              }

              function buildTemplate(isDraft, statusIcon, message, icons, footer) {
                const efficiency = isDraft ? '⚡ **Ultra Fast** (smoke test only)' : '🚀 **Streamlined** (parallel execution)';
                const buildStatus = isDraft ? '⏭️ Skipped (draft)' : icons.build + ' Core platforms';
                const testStatus = isDraft ? '⏭️ Skipped (draft)' : icons.test + ' Parallel execution';

                return '## ' + statusIcon + ' Streamlined CI Results\n\n' +
                  efficiency + '\n\n' +
                  '**Status**: ' + message + '\n\n' +
                  '**Pipeline Summary**:\n' +
                  '- **Validation**: ' + icons.validation + ' Lint & flake check\n' +
                  '- **Build**: ' + buildStatus + '\n' +
                  '- **Tests**: ' + testStatus + '\n\n' +
                  footer;
              }

              // Main logic
              const status = '${{ steps.status.outputs.status }}';
              const message = '${{ steps.status.outputs.message }}';
              const isDraft = '${{ env.CI_MODE }}' === 'draft';

              const statusIcon = getStatusIcon(status);
              const icons = {
                validation: getStatusIcon('${{ needs.validate.result }}'),
                build: getStatusIcon('${{ needs.build-core.result }}'),
                test: getStatusIcon('${{ needs.test-parallel.result }}')
              };

              const footer = isDraft ? '_💡 Mark as ready to run full CI pipeline_' : '_🎯 Optimized for speed: ~5-8 minutes total_';
              const template = buildTemplate(isDraft, statusIcon, message, icons, footer);

              // Find and update existing comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const existingComment = comments.find(comment =>
                comment.user.type === 'Bot' && comment.body.includes('Streamlined CI Results')
              );

              if (existingComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: template
                });
                console.log('Updated existing CI comment');
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: template
                });
                console.log('Created new CI comment');
              }
            } catch (error) {
              console.error('Failed to update PR comment:', error);
              // Continue workflow even if comment fails
            }

      - name: Report continuous-integration status
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.status.outputs.status }}';
            const message = '${{ steps.status.outputs.message }}';
            const state = status === 'success' ? 'success' : 'failure';

            try {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.sha,
                state: state,
                target_url: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                description: message,
                context: 'continuous-integration'
              });
              console.log(`✅ Reported continuous-integration status: ${state}`);
            } catch (error) {
              console.error('Failed to report status:', error);
            }

      - name: Final status check
        run: |
          status="${{ steps.status.outputs.status }}"
          message="${{ steps.status.outputs.message }}"

          if [[ "$status" != "success" ]]; then
            echo "❌ CI pipeline failed: $message"
            exit 1
          else
            echo "✅ CI pipeline succeeded: $message"
          fi
