name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  NIX_CONFIG: |
    max-jobs = auto
    cores = 0
    substituters = https://cache.nixos.org https://nix-community.cachix.org https://baleen-nix.cachix.org
    trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= baleen-nix.cachix.org-1:awgC7Sut148An/CZ6TZA+wnUtJmJnOvl5NThGio9j5k=
    fallback = true
    narinfo-cache-negative-ttl = 0

jobs:
  ci:
    name: CI (${{ matrix.name }})
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Darwin
            os: macos-15
            arch: aarch64
          - name: Linux x64
            os: ubuntu-latest
            arch: x86_64
          - name: Linux ARM64
            os: ubuntu-latest
            arch: aarch64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0

      - name: Setup Nix with cache
        uses: ./.github/actions/setup-nix

      - name: Fast container tests
        continue-on-error: false
        run: |
          export USER=${USER:-ci}
          export TEST_USER=${TEST_USER:-testuser}  # Ensure consistent test user
          echo "üöÄ Running fast container tests with static test user..."
          echo "üìä Environment info:"
          echo "  - USER: $USER"
          echo "  - TEST_USER: $TEST_USER"
          echo "  - RUNNER_OS: $RUNNER_OS"
          make test || {
            echo "‚ùå Fast container tests failed"
            echo "üîç This may be due to cache service issues, not code problems"
            exit 1
          }

      - name: Full test suite
        if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
        continue-on-error: false
        run: |
          export USER=${USER:-ci}
          export TEST_USER=${TEST_USER:-testuser}  # Ensure consistent test user
          echo "üî¨ Running full test suite with static test user..."
          echo "üìä Environment info:"
          echo "  - USER: $USER"
          echo "  - TEST_USER: $TEST_USER"
          echo "  - RUNNER_OS: $RUNNER_OS"
          make test-all || {
            echo "‚ùå Full test suite failed"
            echo "üîç This may be due to cache service issues, not code problems"
            exit 1
          }

      - name: Test secrets backup
        run: |
          export USER=${USER:-ci}
          echo "üîê Testing secrets backup (dry-run)..."
          make -n secrets/backup

      - name: Upload to Cachix
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
        env:
          USER: ${USER:-ci}
          CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true
        run: |
          export USER=${USER:-ci}
          echo "üöÄ Uploading to Cachix (continue-on-error enabled)..."
          if [ "$RUNNER_OS" = "macOS" ]; then
            export NIXNAME=macbook-pro
            # Cache macOS build
            nix build '.#darwinConfigurations.macbook-pro.system' --json \
              | jq -r '.[].outputs | to_entries[].value' \
              | cachix push baleen-nix || echo "‚ö†Ô∏è Cache upload incomplete - continuing..."
          else
            export NIXNAME=vm-aarch64-utm
            # Cache Linux build (use x86_64 since that's our runner)
            nix build '.#nixosConfigurations.vm-aarch64-utm.config.system.build.toplevel' --json \
              | jq -r '.[].outputs | to_entries[].value' \
              | cachix push baleen-nix || echo "‚ö†Ô∏è Cache upload incomplete - continuing..."
          fi

  wsl-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup WSL
        uses: Vampire/setup-wsl@v1

      - name: Install Nix
        uses: cachix/install-nix-action@v22
        with:
          install_url: https://nixos.org/nix/install

      - name: Test WSL configuration
        run: |
          export USER=nixos
          nix flake check --impure
          nix build .#nixosConfigurations.wsl.config.system.build.toplevel --impure
