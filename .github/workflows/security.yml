# ABOUTME: ë³´ì•ˆ ì¤‘ì‹¬ CI íŒŒì´í”„ë¼ì¸
# ABOUTME: ë¯¼ê°ì •ë³´ ê²€ì‚¬ ë° ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”

name: Security

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (UTC)ì— ì‹¤í–‰
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  security-scan:
    name: "ë³´ì•ˆ ìŠ¤ìº” ðŸ”’"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ì €ìž¥ì†Œ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Nix ì„¤ì¹˜
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          logger: pretty

      - name: Magic Nix Cache ì„¤ì •
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: nix develop --command make test-security
        env:
          USER: ${{ github.actor }}

      - name: Secrets ìŠ¤ìº” (GitLeaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config-path: .gitleaks.toml

      - name: ë³´ì•ˆ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            security-*.log
            gitleaks-*.json
          retention-days: 30

      - name: ë³´ì•ˆ ìš”ì•½ ìƒì„±
        if: always()
        run: |
          echo "## ðŸ”’ ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ê²€ì‚¬ í•­ëª©" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ë¯¼ê°ì •ë³´ ë…¸ì¶œ ê²€ì‚¬" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… íŒŒì¼ ê¶Œí•œ ê²€ì¦" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Git ížˆìŠ¤í† ë¦¬ ìŠ¤ìº”" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Secrets íŒ¨í„´ ê²€ì‚¬" >> $GITHUB_STEP_SUMMARY
