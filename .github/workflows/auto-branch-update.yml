name: Auto Branch Update

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  update-prs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_PAT }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update PR branches
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_PAT }}
        run: |
          # Get all open PRs
          gh pr list --state open --json number,headRefName --jq '.[] | "\(.number):\(.headRefName)"' | while IFS=':' read pr branch; do
            echo "Checking PR #$pr ($branch)..."

            # Check if branch is behind main
            BEHIND=$(git rev-list --count "origin/$branch..origin/main" 2>/dev/null || echo "0")

            if [ "$BEHIND" -gt 0 ]; then
              echo "PR #$pr is $BEHIND commits behind main. Updating..."

              # Checkout branch
              git checkout -B "$branch" "origin/$branch"

              # Try to merge main
              if git merge origin/main --no-edit; then
                git push origin "$branch"
                echo "✅ Successfully updated PR #$pr"
              else
                echo "❌ Merge conflict in PR #$pr"
                git merge --abort
                gh pr comment "$pr" --body "⚠️ This PR has conflicts with main and needs manual update."
              fi

              git checkout main
            else
              echo "✅ PR #$pr is already up to date"
            fi
          done
